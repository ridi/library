stages:
  - test

variables:
  AWS_DEFAULT_REGION: ap-northeast-2

build:
  image: ridibooks/gitlab-ci-docker-compose:latest
  stage: build
  script:
    - TAG=$CI_COMMIT_SHA docker-compose -f common.yml build

phpcs:
  image: ridibooks/store-php-test:7.1
  stage: test
  script:
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo "$SSH_SERVER_HOSTKEYS" > ~/.ssh/known_hosts'
    - composer install --dev
    - vendor/bin/phpcs --standard=ruleset.xml
  cache:
    key: composer
    paths:
      - .composer/cache/
